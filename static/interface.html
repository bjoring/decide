<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <title>Starboard Control Panel</title>
        <!-- jQuery and jQuery Mobile -->
        <link rel="stylesheet" href="/static/jquery.mobile-1.3.1.min.css" />
        <link rel="icon" type="image/ico" href="/static/favicon.ico"/>
        <link rel="stylesheet" href="/static/panel.css" />
        <script src="/static/jquery-1.9.1.min.js"></script>
        <script src="/static/jquery.mobile-1.3.1.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/static/d3.v3.min.js" charset="utf-8"></script>
        <!-- Code for socket.io and device orientation handling -->
        <script>

        var pub = io.connect("/PUB");
        var req = io.connect("/REQ");
        // Send data through socket

        var starboard;
        var starstate;

        d3.json("/components", function(err, json) {
        if (err) console.warn(err);
          starboard = d3.entries(json);
        });

        d3.json("/state", function(err, json) {
            if (err) console.warn(err);
            starstate=json;
            drawInterface();
            update();
        });

        pub.on("msg", function(data) {
          if (data.event == "state-changed") {
            starstate = data;
            update();
          }
          else if (data.event == "log") {
            appendConsole(data.reason, "applog");
          }
          else if (data.event == "trial-data") {
        //     trialStatusUpdate("shapelog",msg,meta);
          }


        });

        </script>
    </head>

    <body>
        <div data-role="page" id="page1">
            <div data-role="header">
                <h3>Starboard Control Panel</h3>
            </div>
            <svg id="interface"/>
            <div id="consolecontain">
              <div id="appconsole">
                <h2>Apparatus Log</h2>
                <div id="applog">
                </div>
              </div>
              <div id="shapeconsole">
                <h2>Trial Status</h2>
                <div id="shapelog">
                   <p id="trialblock"/>
                   <p id="message"/>
                </div>
              </div>
            </div>
        </div>
    </body>
    <script>

        var svg;
        function drawInterface(){
            var w = window.innerWidth * 0.7;
            var h = w * 0.5626;

            var numLeds = d3.sum(starboard.map(function(x) { return x.value.type == 'led'; }));
            var numHouse = d3.sum(starboard.map(function(x) { return x.value.type == 'lights'; }));
            var numFeeds = d3.sum(starboard.map(function(x) { return x.value.type == 'feeder'; }));
            var numPecks = d3.sum(starboard.map(function(x) {
              return (x.value.type == "key") ? Object.keys(x.value.variables).length : 0;
            }));

            var xLedScale = d3.scale.ordinal()
                           .domain(d3.range(numLeds))
                           .rangeRoundBands([0, w],0.16);

            var xOmniScale = d3.scale.ordinal()
                           .domain(d3.range(numLeds/3))
                           .rangeRoundBands([0, w], 0.06);

            var xPeckScale = d3.scale.ordinal()
                           .domain(d3.range(numPecks))
                           .rangeRoundBands([0, w], 0.06);

            var xFeedScale = d3.scale.ordinal()
                           .domain(d3.range(numFeeds))
                           .rangeRoundBands([0, w], 0.04);

            var xHouseScale = d3.scale.ordinal()
                           .domain(d3.range(numHouse))
                           .rangeRoundBands([0, w], 0.02);

            var yScale = d3.scale.ordinal()
                        .domain(d3.range(5))
                        .rangeRoundBands([0,h], 0.1)

            svg = d3.select("#interface")
                    .attr("width", w)
                    .attr("height", h)
                    .attr("display","block")

            // filtering data before binding now - CDM
            svg.selectAll(".omni")
                    .data(starboard.filter(function(d) {
                      return d.value.type == "led" && d.value.color == "red"}))
                    .enter()
                    .append("rect")
                    .attr("class", "omni")
                    .attr("x", function(d, i) { return xOmniScale(i); })
                    .attr("y", yScale(1))
                    .attr("width", xOmniScale.rangeBand())
                    .attr("height", yScale.rangeBand()*(4/3))
                    .attr("fill", "black");

            svg.selectAll(".led")
                    .data(starboard.filter(function(d) { return d.value.type == "led"},
                                           function(d) { return d.key}))
                    .enter()
                    .append("rect")
                    .attr("class", function(d) { return "led control " + d.value.color;})
                    .attr("x", function(d, i) { return xLedScale(i); })
                    .attr("y", yScale(2) + yScale.rangeBand()*(1/3))
                    .attr("width", xLedScale.rangeBand())
                    .attr("height", yScale.rangeBand()*(2/3))
                    .on("click", function(d) {
                      req.emit("msg", {
                        req: "change-state",
                        addr: d.key,
                        data: {
                          brightness: !(starstate[d.key].brightness)
                        }
                      })
                    });


            var keys = svg.selectAll(".peckgroup")
                          .data(starboard.filter(function(d) { return d.value.type == "key"},
                                                 function(d) { return d.key}))
                    .enter()
                    .append("g")
                    .attr("class", "peckgroup");

            keys.selectAll(".peck")
                .data(function(d,i) { return d3.entries(d.value.variables) })
                .enter()
                .append("rect")
                .attr("class", "peck control")
                .attr("x", function(d,i) { return xPeckScale(i); })
                .attr("y", yScale(3) )
                .attr("width",  xPeckScale.rangeBand())
                .attr("height", yScale.rangeBand())
                .on("click", function(d) {
                  var groupkey = d3.select(this.parentNode).datum().key;
                  var data = {};
                  data[d.key] = !(starstate[groupkey][d.key]);
                  req.emit("msg", {
                    req: "change-state",
                    addr: groupkey,
                    data: data
                  });
                });

            svg.selectAll(".houselights")
                    .data(starboard.filter(function(x) { return x.value.type == "lights"},
                                           function(x) { return x.key}))
                    .enter()
                    .append("rect")
                    .attr("class", "houselights control")
                    .attr("x", function(d, i) {
                      return xHouseScale(i);
                    })
                    .attr("y", yScale(0)+yScale.rangeBand()/2)
                    .attr("width", xHouseScale.rangeBand())
                    .attr("height", yScale.rangeBand()/2)
                    // TODO show sun position?
                    .on("click", function(d) {
                      if (starstate[d.key] >= 250) {
                        updateServer(Date.now(),{"key": d.key, "state":0,"name":d.name});
                      } else if (starstate[d.key] === 0) {
                        updateServer(Date.now(),{"key": d.key, "state":100,"name":d.name});
                      } else {
                        updateServer(Date.now(),{"key": d.key, "state":starstate[d.key]+50,"name":d.name});
                      }
                    });

            svg.selectAll(".feeder")
                    .data(starboard.filter(function(x) { return x.value.type == "feeder"},
                                           function(x) { return x.key}))
                    .enter()
                    .append("rect")
                    .attr("class", "feeder control")
                    .attr("x", function(d, i) {
                      return xFeedScale(i);
                    })
                    .attr("y", yScale(4))
                    .attr("width", xFeedScale.rangeBand())
                    .attr("height", yScale.rangeBand()/2)
                    .on("click", function(d) {
                      req.emit("msg", {
                        req: "change-state",
                        addr: d.key,
                        data: {feeding: true},
                      });
                    });
        }


        function getColor(d, i) {
                var color;
                var brightness;

                if (starstate[d.key] == 1 || d == 1) brightness = 225;
                else brightness = 90

                if (d.color == "red" || i % 3 == 0) color = [brightness,0,0];
                else if (d.color == "green" || i % 3 == 1) color = [0,brightness,0];
                else if (d.color == "blue" || i % 3 == 2) color = [0,0,brightness];

                return "rgb("+color+")";
            }

        function updateOmni() {
                var left = [225*starstate.lcr,
                            225*starstate.lcg,
                            225*starstate.lcb];

                var center = [225*starstate.ccr,
                              225*starstate.ccg,
                              225*starstate.ccb];

                var right = [225*starstate.rcr,
                              225*starstate.rcg,
                              225*starstate.rcb];

                svg.selectAll(".omni")
                    .attr("fill", function(d,i){
                        if (i == 0) return "rgb("+left+")";
                        else if (i==1) return "rgb("+center+")";
                        else return "rgb("+right+")"
                });
            }

        function updatePeck() {
                svg.selectAll(".peck")
                .attr("fill", function(d,i){
                        if (starstate[d.key] == 1) return "black";
                        else return "salmon";
                    });
            }

        function updateHouse() {
                svg.selectAll(".houselights")
                .attr("fill", function(d,i){
                        color = [starstate[d.key],starstate[d.key],0];
                        return "rgb("+color+")";
                    });
            }

        function updateFeed() {
                svg.selectAll(".feed")
                .attr("fill", function(d,i){
                        if (starstate[d.key] == 0) return "black";
                        else return "blueviolet";
                    });
            }

        function appendConsole(data, console) {
            var target = "#"+console;
            d3.selectAll(target).append("p").text(data);

            var objDiv = document.getElementById(console);
            objDiv.scrollTop = objDiv.scrollHeight;

        }

        function trialStatusUpdate(console, msg, meta) {
            var target = "#"+console;
                d3.selectAll("#trialblock").text(function(){
                    if (meta.block) return ("Block: " + meta.block +", Trial "+meta.trial);
                    else return ("Trial " + meta.trial);
                });
            d3.selectAll("#message").text(function(){
                return (msg +" -  "+meta.timestamp);
            });
        }

        function update() {
                svg.selectAll(".led")
                    .attr("fill", function(d,i){

                        var color = getColor(d,i);
                        return color;
                });
                updateOmni();
                updatePeck();
                updateHouse();
                updateFeed();
        }

    </script>

</html>
