<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Starboard Directory</title>
    <!-- jQuery and jQuery Mobile -->
    <link rel="stylesheet" href="/static/css/jquery.mobile-1.3.1.min.css" />
    <link rel="icon" type="image/ico" href="/static/images/favicon.ico" />
    <link rel="stylesheet" href="/static/css/directory.css" />
  </head>

  <body>
    <div data-role="page" id="page1">
      <div data-role="header" class="hbar">
        <h3>Starboard Directory</h3>
      </div>
      <div id="boxlist">
        <p class="ahead">Registered Boxes</p>
      </div>

      <script src="/static/js/jquery-1.9.1.min.js"></script>
      <script src="/static/js/jquery.mobile-1.3.1.min.js"></script>
      <script src="/static/js/socket.io.js"></script>
      <script src="/static/js/queue.v1.min.js" charset="utf-8"></script>
      <script src="/static/js/d3.v3.min.js" charset="utf-8"></script>

      <!-- Code for socket.io and device orientation handling -->
      <script>
        var controllers;

        // need to force socket.io to use a relative path in case we are proxied
        var sock = io.connect("/", {path: location.pathname + "socket.io"});

        d3.json("controllers", function(err, data) {
            if (err) console.warn(err);
            else {
                controllers = data;
                drawDirectory();


                                        pub.on("disconnect", function(){
                                                alert("Error: Disconnected from PUB channel.")
                                        })

                                        req.on("disconnect", function(){
                                                alert("Error: Disconnected from REQ channel.")
                                        })

                                        pub.on("msg", function(msg) {
                                                if (msg.event == "box-registered") {
                                                        boxes[msg.data.name] = msg.data;
                                                        drawDirectory();
                                                } else if (msg.event == "box-unregistered") {
                                                        delete boxes[msg.data.name];
                                                        drawDirectory();
                                                }
                                        });
                                }
                        }
               );
        function drawDirectory() {
                var data = d3.entries(boxes);

                var boxlist = d3.select("#boxlist");
                boxlist.selectAll(".abox").remove();
                boxlist.selectAll(".abox")
                        .data(data)
                        .enter()
                        .append("p")
                        .attr("class", "abox")
                        .append("a")
                        .attr("href", function(d) {
                                console.log(d);
                                var link = "/device/" + d.value.name + "/";
                                return link;
                        })
                        .text(function(d) {
                                return d.key;
                        });
        }
        </script>
  </body>
</html>
