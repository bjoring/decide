
# Beaglebone Black Setup

`decide` runs in `node.js` and can theoretically be used on any POSIX computer. It can be run in "dummy" mode for development purposes. However, its intended use is with a low-cost, single-board computer like the Beaglebone Black (BBB) that provides access to digital input and outputs. These lines can be run to physical devices that an animal can interact with during behavioral experiments.

This document assumes that you have a working BBB and that you understand how to start up the board, connect to it through the USB cable, and access the device through a browser and ssh. Once you are comfortable with using this computer, install the [starboard](http://meliza.org/starboard/) expansion cape by pressing the pins firmly into the expansion headers, making sure that they are correctly aligned. The `starboard` provides 9 low-power digital outputs, 3 high-power digital outputs, 4 digital inputs that can be wired to switches or beam-break detectors, and a 16-bit stereo DAC and amplifier.

Your `starboard` should have come with a micro-SD card that contains a complete boot image and copy of the `decide` software. If you don't have this card, [this document](ossetup.md) will tell you how to download or clone an existing image and write it to a card.  Plug the card into the uSD card slot and hold down the boot button while turning on the board. The LEDs on the cape should light dimly at first and then go dark as the I/O pins are configured. You should then be able to connect to the BBB through the supplied USB cable.

# Starting the software

The boot image comes with the latest stable version of `decide` installed under `/root/decide`. If you would like to upgrade to the current development version, change to this directory and run `git checkout -b develop origin/develop`, copy `native/binding.gyp` to `/root/decide` and then run `npm install`. The last command will install any missing `node` dependencies.

The main component of the software consists of a controller script, `decide-ctrl.js`, which manages connected devices, logs trial and event data, and provides a web interface for monitoring and manipulating the apparatus.  First, let's explore the software in a standalone mode. Copy or link `config/host-config-standalone.json` to `config/host-config.json`, then execute `scripts/decide-ctrl.js`. You should see a lot of log messages as the program initializes state. Now point your browser at <http://beaglebone.local:8000> (substitute the appropriate hostname if you changed it). You should see an interface that represents the operant panel, with the house light at the top, then the three RGB cue lights, then the peck keys, and then the hoppers. You can change the state of the apparatus by clicking on the components in the interface, and if you block the beam-break detectors (or press the switches) for the response keys, you should see the appropriate element light up. Under the hood, when you interact with the interface, your browser sends messages to `decide-ctrl` requesting that it change the state of a component; `decide-ctrl` sends messages to the browser indicating when it changes state.

Experiments are run in separate processes that connect to `decide-ctrl.js` through the same websockets interface as your browser and manipulate the state of the apparatus through messages. Experiments themselves have state depending on which phase of a trial they're in. `decide` ships with three experiment programs: `lights`, `shape`, and `gng`.

**lights** simply sets the house lights (one of the high-power outputs of `starboard`) to an intensity that matches the local position of the sun.  You can use `lights` when you have an animal on ad lib food. Let's try running it.  At this point, you may want to consider running these programs in `screen`, a virtual terminal program that will let you have multiple virtual screens that don't kill the programs if you get disconnected. You'll need to tell `lights` the name of your subject and give an email it can contact if there are problems. For example: `scripts/lights.js subj_1 me@host.com`. If your browser is still open, you should see it update to indicate that the `lights` procedure is running, the process id, the subject, and your email. If you hover over the house lights bar at the top of the interface, you'll see information about the sun's altitude and the brightness.  If you want to run the animal on a different light cycle, you can edit `config/bbb-config.json` and edit the `house_lights` item to set latitude and longitude or a fixed start and stop time.  To end the `lights` experiment, type ctrl-C in the terminal. At present, it's not possible to start and stop experiments from the web interface.

For instructions on shaping and running a go-no-go experiment, see the [next section](experiments.md).

# Calibrating the feeder outputs

(this section is not applicable at the moment - PWM drive to solenoids is not enabled)

The left and right feeders are controlled through two digital output lines that support pulse width modulation (PWM). These lines may, for example, trigger solenoids that push or pull a food hopper into position. Depending on the physical configuration of the hopper and solenoid, the force needed to raise the hopper into position may be less than the force needed to hold the hopper, and/or less than the full force the solenoid can deliver. PWM allows the total power delivered to the solenoid to be more precisely controlled than a simple on/off digital line. The default image comes configured to use PWM (using the programmable realtime unit on the BBB), but you need to calibrate the power settings, which are found in `config/bbb-config.json` under the `feeder_left` and `feeder_right` keys. The relevant settings are `mode`, `pulse_duty`, `pulse_dur`, and `hold_duty`. Currently only one mode is supported (`pulse-hold`), which operates the solenoid at one duty cycle (`pulse_duty`) for a fixed duration (`pulse_dur`, in ms) and then switches to a hold duty cycle (`hold_duty`) until the feeder is turned off. Duty cycle values range between 0 and 100 and correspond to the percentage of the total power. You will have to tweak these values to reflect your setup.

In the Meliza Lab, the solenoids are part of the response panel and pull the hoppers into position, so the initial pulse needs to be powerful enough to get the hopper moving, but the power needed to hold the hopper in position is much less (this reflects the fact that the force delivered by a solenoid is inversely proportional to the extension, and extension is close to zero when the hopper is fully engaged). The default values in `bbb-config.json` reflect this configuration, delivering a 100 ms pulse at 73% duty cycle and then holding at 10%. For each apparatus, we adjust `pulse_duty` so that a fully loaded hopper can just be pulled into position, thereby minimizing the noise from the hopper engaging and reducing mechanical stress as much as possible.

# Connecting to a host computer

Many experimenters will eventually want to scale up to multiple devices so they can run several experiments in parallel. `decide` was written with this model in mind. Each BBB runs independently, providing a high degree of fault tolerance, but multiple devices can all be connected in a private network with a host computer that acts as a gateway. Scaling up is as simple as configuring another device, giving it a unique hostname, and connecting it to your network.

For networked operation, you'll need to download the `decide-host` repository, which contains the software and instructions for configuring the local network. You will need to edit the `config/host-config.json` file on the controller to tell `decide-ctrl` how to connect to the host computer. The `config/host-config-network.json` file gives example values. Make sure `standalone` is set to `false`, and set `addr` to the IP address of the host computer and `mail_transport` to the SMTP port of a computer that can deliver error messages by email. If your host computer is set up to deliver email, you can use its address. If `decide-ctrl` succeeds in connecting to the host computer, you will see a field showing its address in the web interface.
