<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<title>Starboard Directory</title>
	<!-- jQuery and jQuery Mobile -->
	<link rel="stylesheet" href="/static/jquery.mobile-1.3.1.min.css" />
	<link rel="icon" type="image/ico" href="/static/favicon.ico"/>
	<link rel="stylesheet" href="/static/directory.css" />
	<script src="/static/jquery-1.9.1.min.js"></script>
	<script src="/static/jquery.mobile-1.3.1.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="/static/queue.v1.min.js" charset="utf-8"></script>
	<script src="/static/d3.v3.min.js" charset="utf-8"></script>
	<!-- Code for socket.io and device orientation handling -->
	<script>
		var pub = io.connect("/HPUB");
		var req = io.connect("/HREQ");

		var boxes;

		queue()
		.defer(d3.json, "/boxes")
		.await(function(err, data)  {
			if (err) console.warn(err);
			else {
				boxes = data;
				console.log(boxes);
				drawDirectory();

				pub.on("msg", function(msg) {
					if (msg.event == "box-registered") {
						boxes[msg.data.name] = msg.data;
						drawDirectory();
					} else if (msg.event == "box-unregistered") {
						delete boxes[msg.data];
						drawDirectory();
					}
				});
			}
		});
	</script>
</head>

<body>
	<div data-role="page" id="page1">
		<div data-role="header" class="hbar">
			<h3 id="hbartext">Starboard Directory</h3>
		</div>
		<div id="boxlist">
		<p class="ahead">Registered Boxes</p>
		</div>
	</body>
	<script>
		function drawDirectory() {
			var data = d3.entries(boxes);

			var boxlist = d3.select("#boxlist")

			boxlist.selectAll("#abox")
			.data(data)
			.enter()
			.append("p")
			.attr("class","abox")
			.append("a")
			.attr("href", function(d) {
				console.log(d);
				var link = "http://"+d.value.ip+":"+d.value.port;
				return link
			})
			.text(function(d){
				return d.key;
			})
		}
	</script>
	</html>
