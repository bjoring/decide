<!DOCTYPE html>
<html>
    
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <title>Starboard Control Panel</title>
        <!-- jQuery and jQuery Mobile -->
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css"
        />
        <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <!-- Code for socket.io and device orientation handling -->
        <script>
            var socket = io.connect();
            // Send data through socket

            var initialState = [0,0,0,0,0,0];
            
 var starboard = {    // the  six leds
                    "lcr": { // left red
                            "name": "left red led",
                            "type": "led",
                            "color": "red",
                            "state": 0, 
                            "abstract_state": "off",
                    }, 
                    "lcg":{ // left green
                            "name": "left green led",
                            "type": "led",
                            "color": "green",
                            "state": 0, 
                            "abstract_state": "off",
                    }, 
                    "lcb":{ //left blue
                            "name": "left blue led",
                            "color": "blue",
                            "type": "led",
                            "state": 0,    
                            "abstract_state": "off"
                    },

                    "ccr":{ // center red
                            "name": "center red led",
                            "type": "led",
                            "color": "red",
                            "state": 0,    
                            "abstract_state": "off"
                    }, 
                    "ccg":{ // center green
                            "name": "center green led",
                            "type": "led",
                            "color": "green",
                            "state": 0, 
                            "abstract_state": "off",
                    }, 
                    "ccb":{ //center blue
                            "name": "center blue led",
                            "type": "led",
                            "color": "blue",
                            "state": 0,    
                            "abstract_state": "off"
                    },
                    "rcr": { // right red
                            "name": "right red led",
                            "type": "led",
                            "color": "red",
                            "state": 0, 
                            "abstract_state": "off",
                    }, 

                    "rcg":{ // right green
                            "name": "right green led",
                            "type": "led",
                            "color": "green",
                            "state": 0, 
                            "abstract_state": "off",
                    }, 
                    "rcb":{ //right blue
                            "name": "right blue led",
                            "color": "blue",
                            "type": "led",
                            "state": 0,    
                            "abstract_state": "off"
                    }, 

                    // the beam break detectors (pecks)
                    "cp": { // center peck
                            "name": "center peck",
                            "type": "beambreak",
                            "state": 1,
                            "abstract_state": "nopeck"
                    }
            }
            
            var numLeds = 9;
            
            var numPecks = 1;
            
            socket.on('updateState', function(data) {
                sync(data);
                update();
            });
            
        
        </script>
    </head>
    
    <body>
        <div data-role="page" id="page1">
            <div data-role="header">
                <h3>Starboard Control Panel</h3>
            </div>
        </div>
    </body>
    <script>
    
        var w = window.innerWidth * 0.4;
        var h = window.innerHeight * 0.3;
        
        var xLedScale = d3.scale.ordinal()
                       .domain(d3.range(numLeds))
                       .rangeRoundBands([0, w], 0.15);
                       
        var xOmniScale = d3.scale.ordinal()
                       .domain(d3.range(numLeds/3))
                       .rangeRoundBands([0, w], 0.05);
        
        var xPeckScale = d3.scale.ordinal()
                       .domain(d3.range(numPecks))
                       .rangeRoundBands([0, w], 0.02);
                       
        var yScale = d3.scale.ordinal()
                    .domain(d3.range(5))
                    .rangeRoundBands([0,h], 0.1)
        
        var svg = d3.select("#page1")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", "40%")
                    .attr("display","block")
                    .attr("style", "margin-left: auto; margin-right: auto")
                    .attr("margin-right","auto");
            
        svg.selectAll(".led")
                .data(d3.values(starboard), function(d) {
                return d.name;
            })
                .enter()
                .append("rect")
                .filter(function(d) {
                if (d.type == "led") return d;
            })
                .attr("class", "led")
                .attr("x", function(d, i) {
                     return xLedScale(i);
            })
                .attr("y", yScale(2))
                .attr("width", xLedScale.rangeBand())
                .attr("height", yScale.rangeBand())
                .attr("fill", function(d, i) {
                    var color = getColor(0, i);
                return color;
            })
                .attr("stroke", function(d, i) {
                var color = getColor(1, i);
                return color;
            })
                .attr("stroke-width", "0")
                .attr("style", "cursor:pointer")
                .on("mouseover", function() {
                return d3.select(this).attr("stroke-width", "2");
            })
                .on("mouseout", function() {
                return d3.select(this).attr("stroke-width", "0");
            })
            .on("click", function(d, i) {
                if (d.state == 0) {
                    d.state = 1;
                    updateServer();
                } else {
                    d.state = 0;
                    updateServer();
                }
            });
            
            svg.selectAll(".omni")
                .data(d3.values(starboard))
                .enter()
                .append("rect")
            .filter(function(d){if (d.color == "red") return d;})
                .attr("class", "omni")
                .attr("x", function(d, i) {
                    return xOmniScale(i);
                 })
                .attr("y", yScale(1))
                .attr("width", xOmniScale.rangeBand())
                .attr("height", yScale.rangeBand())
                .attr("fill", "black");
                
                    
        svg.selectAll(".peck")
                .data(d3.values(starboard), function(d) {
                return d.name;
            })
                .enter()
                .append("rect")
                .filter(function(d) {
                if (d.type == "beambreak") return d;
            })
                .attr("class", "peck")
                .attr("x", function(d,i) {
                    return xPeckScale(i);
                })
                .attr("y", yScale(3) )
                .attr("width",  xPeckScale.rangeBand())
                .attr("height", yScale.rangeBand())
                .attr("color", "black")
                .attr("stroke", "orange")
                .attr("stroke-width", "0")
                .attr("style", "cursor:pointer")
                .on("mouseover", function() {
                return d3.select(this).attr("stroke-width", "2");
            })
                .on("mouseout", function() {
                return d3.select(this).attr("stroke-width", "0");
            })
                .on("click", function(d) {
                if (d == 0) {
                    d.state = 0;
                    updateServer();
                } else {
                    d.state = 1;
                    updateServer();
                }
            });
            

        function countType(data, targetType) {
            var i = 0;
            var count = 0;
            
            var data = d3.values(data);
            
            for (i; i <= data.length; i++) {
                if (data[i].type == "led") count += 1;
            }
            return count;
        }

        function updateServer() {
            //update(dataset);
            socket.emit("updateServer", starboard);
        }
        
        function getColor(d, i) {
            var color;
            var brightness;
            
            if (d.state == 1 || d == 1) brightness = 225;
            else brightness = 90
            
            if (d.color == "red" || i % 3 == 0) color = [brightness,0,0];
            else if (d.color == "green" || i % 3 == 1) color = [0,brightness,0];
            else if (d.color == "blue" || i % 3 == 2) color = [0,0,brightness];
            
            return "rgb("+color+")";
        }
        
        function updateOmni() {    

            var left = [225*starboard.lcr.state,
                        225*starboard.lcg.state,
                        225*starboard.lcb.state];
                        
            var center = [225*starboard.ccr.state,
                          225*starboard.ccg.state,
                          225*starboard.ccb.state];
            
            var right = [225*starboard.rcr.state,
                          225*starboard.rcg.state,
                          225*starboard.rcb.state];
            
            svg.selectAll(".omni")
                .attr("fill", function(d,i){
                    if (i == 0) return "rgb("+left+")";
                    else if (i==1) return "rgb("+center+")";
                    else return "rgb("+right+")"
            });
        }
        
        function updatePeck() {
            svg.selectAll(".peck")
            .attr("fill", function(){
                    if (starboard.cp.state == 1) return "black";
                    else return "orange";
                });
        }
    
        function sync(data) {
                starboard.rcr.state = data.rcr.state;
                starboard.rcr.abstract_state = data.rcr.abstract_state;
                
                starboard.rcg.state = data.rcg.state;
                starboard.rcg.abstract_state = data.rcg.abstract_state;
                
                starboard.rcb.state = data.rcb.state;
                starboard.rcb.abstract_state = data.rcb.abstract_state;
                
                starboard.ccr.state = data.ccr.state;
                starboard.ccr.abstract_state = data.ccr.abstract_state;
                
                starboard.ccg.state = data.ccg.state;
                starboard.ccg.abstract_state = data.ccg.abstract_state;
                
                starboard.ccb.state = data.ccb.state;
                starboard.ccb.abstract_state = data.ccb.abstract_state;
                
                starboard.lcr.state = data.lcr.state;
                starboard.lcr.abstract_state = data.ccr.abstract_state;
                
                starboard.lcg.state = data.lcg.state;
                starboard.lcg.abstract_state = data.lcg.abstract_state;
                
                starboard.lcb.state = data.lcb.state;
                starboard.lcb.abstract_state = data.lcb.abstract_state;
                
                starboard.cp.state = data.cp.state;
                starboard.cp.abstract_state = data.cp.state;
            }
    
        function update() {
            svg.selectAll(".led")
                .attr("fill", function(d,i){
                    
                    var color = getColor(d,i);
                    return color;
            });
            updateOmni();
            updatePeck();
        }

    </script>

</html>
