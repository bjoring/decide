<!DOCTYPE html>
<html>
    
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <title>Starboard Control Panel</title>
        <!-- jQuery and jQuery Mobile -->
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css"
        />
        <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <!-- Code for socket.io and device orientation handling -->
        <script>
        
        var socket = io.connect();
        // Send data through socket
        
        var starboard;
        var starstate;
            
        d3.json("starboard", function(err, json) {
        if (err) console.warn(err);
            starboard = json;
        });
        
        d3.json("starstate", function(err, json) {
        if (err) console.warn(err);
            starstate=json;
            drawInterface();
            update();
        });
            
        socket.on('updateState', function(data) {
            starstate = data;
            update();
        });
        
        socket.on('simulatedPeck', function(data){
            stateQuery();
        })

        socket.on('appLog', function(msg){
            appendConsole(msg, "applog");
        })
       
        socket.on('shapeLog', function(msg, meta){
            trialStatusUpdate("shapelog",msg,meta);
        }) 
        


        </script>
    </head>
    
    <body>
        <div data-role="page" id="page1">
            <div data-role="header">
                <h3>Starboard Control Panel</h3>
            </div>
        </div>
    </body>
    <script>
    
        var svg;
        function drawInterface(){
            var w = window.innerWidth * 0.7;
            var h = w * 0.5626;
            
            var numLeds = countDevice("led", starboard);
            var numPecks = countDevice("beambreak", starboard);
            var numHouse = countDevice("houselights", starboard);
            var numFeeds = countDevice("feed", starboard);
            
            var xLedScale = d3.scale.ordinal()
                           .domain(d3.range(numLeds))
                           .rangeRoundBands([0, w],0.16);
                           
            var xOmniScale = d3.scale.ordinal()
                           .domain(d3.range(numLeds/3))
                           .rangeRoundBands([0, w], 0.06);
            
            var xPeckScale = d3.scale.ordinal()
                           .domain(d3.range(numPecks))
                           .rangeRoundBands([0, w], 0.06);
            
            var xFeedScale = d3.scale.ordinal()
                           .domain(d3.range(numFeeds))
                           .rangeRoundBands([0, w], 0.04);
            
            var xHouseScale = d3.scale.ordinal()
                           .domain(d3.range(numHouse))
                           .rangeRoundBands([0, w], 0.02);
                           
            var yScale = d3.scale.ordinal()
                        .domain(d3.range(5))
                        .rangeRoundBands([0,h], 0.1)
            
            svg = d3.select("#page1")
                        .append("svg")
                        .attr("width", w)
                        .attr("height", h)
                        .attr("display","block")
                        .attr("style", "margin-left: auto; margin-right: auto")
                
            svg.selectAll(".omni")
                    .data(d3.values(starboard))
                    .enter()
                    .append("rect")
                .filter(function(d){if (d.color == "red") return d;})
                    .attr("class", "omni")
                    .attr("x", function(d, i) {
                        return xOmniScale(i);
                     })
                    .attr("y", yScale(1))
                    .attr("width", xOmniScale.rangeBand())
                    .attr("height", yScale.rangeBand()*(4/3))
                    .attr("fill", "black");
            
            svg.selectAll(".led")
                    .data(d3.values(starboard), function(d) {
                    return d.key;
                })
                    .enter()
                    .append("rect")
                    .filter(function(d) {
                    if (d.type == "led") return d;
                })
                    .attr("class", "led")
                    .attr("x", function(d, i) {
                         return xLedScale(i);
                })
                    .attr("y", yScale(2) + yScale.rangeBand()*(1/3))
                    .attr("width", xLedScale.rangeBand())
                    .attr("height", yScale.rangeBand()*(2/3))
                    .attr("fill", function(d, i) {
                        var color = getColor(0, i);
                    return color;
                })
                    .attr("stroke", function(d, i) {
                    var color = getColor(1, i);
                    return color;
                })
                    .attr("stroke-width", "0")
                    .attr("style", "cursor:pointer")
                    .on("mouseover", function() {
                    return d3.select(this).attr("stroke-width", "2");
                })
                    .on("mouseout", function() {
                    return d3.select(this).attr("stroke-width", "0");
                })
                    .on("click", function(d) {
                    if (starstate[d.key] == 0) {
                        updateServer(Date.now(),{"key": d.key, "state":1,"name":d.name});
                    } else {
                        updateServer(Date.now(),{"key": d.key, "state":0, "name":d.name});
                    }
                });
                    
                        
            svg.selectAll(".peck")
                    .data(d3.values(starboard), function(d) {
                    return d.key;
                })
                    .enter()
                    .append("rect")
                    .filter(function(d) {
                    if (d.type == "beambreak") return d;
                })
                    .attr("class", "peck")
                    .attr("x", function(d,i) {
                        return xPeckScale(i);
                    })
                    .attr("y", yScale(3) )
                    .attr("width",  xPeckScale.rangeBand())
                    .attr("height", yScale.rangeBand())
                    .attr("color", "black")
                    .attr("stroke", "salmon")
                    .attr("stroke-width", "0")
                    .attr("style", "cursor:pointer")
                    .on("mouseover", function() {
                    return d3.select(this).attr("stroke-width", "2");
                })
                    .on("mouseout", function() {
                    return d3.select(this).attr("stroke-width", "0");
                })
                    .on("click", function(d) {
                    if (starstate[d.key] == 0) {
                        simulatePeck(Date.now(),{"key": d.key, "state":1,"name":d.name});
                    } else {
                        simulatePeck(Date.now(),{"key": d.key, "state":0,"name":d.name});                    
                        
                    }
                });
            
            svg.selectAll(".houselights")
                    .data(d3.values(starboard), function(d) {
                    return d.key;
                })
                    .enter()
                    .append("rect")
                    .filter(function(d) {
                    if (d.type == "houselights") return d;
                })
                    .attr("class", "houselights")
                    .attr("x", function(d, i) {
                         return xHouseScale(i);
                })
                    .attr("y", yScale(0)+yScale.rangeBand()/2)
                    .attr("width", xHouseScale.rangeBand())
                    .attr("height", yScale.rangeBand()/2)
                    .attr("fill", "black")
                    .attr("stroke", "yellow")
                    .attr("stroke-width", "0")
                    .attr("style", "cursor:pointer")
                    .on("mouseover", function() {
                    return d3.select(this).attr("stroke-width", "2");
                })
                    .on("mouseout", function() {
                    return d3.select(this).attr("stroke-width", "0");
                })
                    .on("click", function(d) {
                    if (starstate[d.key] >= 250) {
                            updateServer(Date.now(),{"key": d.key, "state":0,"name":d.name});
                    } else if (starstate[d.key] === 0) {
                            updateServer(Date.now(),{"key": d.key, "state":100,"name":d.name});                    
                        
                    } else {
                        updateServer(Date.now(),{"key": d.key, "state":starstate[d.key]+50,"name":d.name});
                    }
                });
         
            svg.selectAll(".feed")
                    .data(d3.values(starboard), function(d) {
                    return d.key;
                })
                    .enter()
                    .append("rect")
                    .filter(function(d) {
                    if (d.type == "feed") return d;
                })
                    .attr("class", "feed")
                    .attr("x", function(d, i) {
                         return xFeedScale(i);
                })
                    .attr("y", yScale(4))
                    .attr("width", xFeedScale.rangeBand())
                    .attr("height", yScale.rangeBand()/2)
                    .attr("fill", "black")
                    .attr("stroke", "blueviolet")
                    .attr("stroke-width", "0")
                    .attr("style", "cursor:pointer")
                    .on("mouseover", function() {
                    return d3.select(this).attr("stroke-width", "2");
                })
                    .on("mouseout", function() {
                    return d3.select(this).attr("stroke-width", "0");
                })
                    .on("click", function(d) {
                   if (starstate[d.key] == 1) {
                        updateServer(Date.now(),{"key": d.key, "state":0,"name":d.name});
                    } else {
                        updateServer(Date.now(),{"key": d.key, "state":1,"name":d.name});                    
                        
                    }
                }); 
            
            d3.select('#page1').append('div')
                                .attr("id", "consolecontain")
                                .attr('style',"width:67%; margin-left: auto;margin-right: auto; font-family:Lucida Console; font-size:small;");
                                
            d3.select('#consolecontain').append('div')
                        .attr("id","appconsole")
                        .attr('style','display:inline-block;height:210px; width: 49%;margin: 0 auto;')
                        
            d3.select('#appconsole').append("h2").text("Apparatus Log:");
            
            d3.select('#appconsole').append('div').attr("id", "applog")
                                    .attr('style','display:inline-block;height:120%; width: 100%;margin: 0 auto;overflow-y:auto;')
                        
            d3.select('#consolecontain').append('div')
                        .attr("id","shapeconsole")
                        .attr('style','display:inline-block;height:210px; width: 49%;margin: 0 auto; padding-left: 2%')
                        
            d3.select('#shapeconsole').append("h2").text("Trial Status: ");
            
            d3.select('#shapeconsole').append('div').attr("id", "shapelog")
                                    .attr('style','display:inline-block;height:120%; width: 100%;margin: 0 auto; overflow-y:auto;')
            d3.select('#shapelog').append('p').attr('id','trialblock');
            d3.select('#shapelog').append('p').attr('id','message');
            
        }
        
        function countDevice(target, starboard) {
            var i = 0;
            for (device in starboard) {
                if (starboard[device].type == target) i++;
            }
            return i;
        }
    
        function updateServer(timestamp, data) {
                socket.emit("updateServer", timestamp, data);
            }
            
        function simulatePeck(timestamp, data) {
                socket.emit("simulatePeck", timestamp, data);
            }
        
        function stateQuery() {
            socket.emit("stateQuery");
        }
            
        function getColor(d, i) {
                var color;
                var brightness;
                
                if (starstate[d.key] == 1 || d == 1) brightness = 225;
                else brightness = 90
                
                if (d.color == "red" || i % 3 == 0) color = [brightness,0,0];
                else if (d.color == "green" || i % 3 == 1) color = [0,brightness,0];
                else if (d.color == "blue" || i % 3 == 2) color = [0,0,brightness];
                
                return "rgb("+color+")";
            }
            
        function updateOmni() {    
                var left = [225*starstate.lcr,
                            225*starstate.lcg,
                            225*starstate.lcb];
                            
                var center = [225*starstate.ccr,
                              225*starstate.ccg,
                              225*starstate.ccb];
                
                var right = [225*starstate.rcr,
                              225*starstate.rcg,
                              225*starstate.rcb];
                
                svg.selectAll(".omni")
                    .attr("fill", function(d,i){
                        if (i == 0) return "rgb("+left+")";
                        else if (i==1) return "rgb("+center+")";
                        else return "rgb("+right+")"
                });
            }
            
        function updatePeck() {
                svg.selectAll(".peck")
                .attr("fill", function(d,i){
                        if (starstate[d.key] == 1) return "black";
                        else return "salmon";
                    });
            }
        
        function updateHouse() {
                svg.selectAll(".houselights")
                .attr("fill", function(d,i){
                        color = [starstate[d.key],starstate[d.key],0];
                        return "rgb("+color+")";
                    });
            }
            
        function updateFeed() {
                svg.selectAll(".feed")
                .attr("fill", function(d,i){
                        if (starstate[d.key] == 0) return "black";
                        else return "blueviolet";
                    });
            }
        
        function appendConsole(data, console) {
            var target = "#"+console;
            d3.selectAll(target).append("p").text(data);
            
            var objDiv = document.getElementById(console);
            objDiv.scrollTop = objDiv.scrollHeight;
        
        }
        
        function trialStatusUpdate(console, msg, meta) {
            var target = "#"+console;
                d3.selectAll("#trialblock").text(function(){
                    if (meta.block) return ("Block: " + meta.block +", Trial "+meta.trial);
                    else return ("Trial " + meta.trial);
                });
            d3.selectAll("#message").text(function(){
                return (msg +" -  "+meta.timestamp);
            });
        }

        function update() {
                svg.selectAll(".led")
                    .attr("fill", function(d,i){
                        
                        var color = getColor(d,i);
                        return color;
                });
                updateOmni();
                updatePeck();
                updateHouse();
                updateFeed();
            }

    </script>

</html>
